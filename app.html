<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>家計分攤器</title>
    <!-- 解決 Electron 中 UMD 模組加載問題 -->
    <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- 改用更穩定的 CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>if (window.module) module = window.module;</script>
    <style>
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; }
        .modal-overlay { background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px); }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .tab-active { background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); color: #4F46E5; }
        .transition-all { transition: all 0.2s ease; }
        .glass-card { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #E2E8F0; border-radius: 10px; }
    </style>
</head>
<body class="bg-[#F8FAFC]">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;
        
        // Electron 檔案系統支援
        const fs = window.require ? window.require('fs') : null;
        const path = window.require ? window.require('path') : null;
        
        // 資料檔案路徑 - 使用應用程式當前目錄
        const getDataPath = () => {
            if (fs && path) {
                // 使用 process.cwd() 取得當前工作目錄
                const appPath = process.cwd();
                const dataDir = path.join(appPath, 'data');
                // 確保 data 資料夾存在
                if (!fs.existsSync(dataDir)) {
                    fs.mkdirSync(dataDir, { recursive: true });
                }
                return path.join(dataDir, 'history.json');
            }
            return null;
        };
        
        // 讀取歷史紀錄檔案
        const loadHistoryFromFile = () => {
            const dataPath = getDataPath();
            if (dataPath && fs && fs.existsSync(dataPath)) {
                try {
                    const data = fs.readFileSync(dataPath, 'utf-8');
                    return JSON.parse(data);
                } catch (e) {
                    console.error('讀取歷史紀錄失敗:', e);
                    return [];
                }
            }
            return [];
        };
        
        // 儲存歷史紀錄到檔案
        const saveHistoryToFile = (historyData) => {
            const dataPath = getDataPath();
            if (dataPath && fs) {
                try {
                    fs.writeFileSync(dataPath, JSON.stringify(historyData, null, 2), 'utf-8');
                    return true;
                } catch (e) {
                    console.error('儲存歷史紀錄失敗:', e);
                    return false;
                }
            }
            return false;
        };

        const SimpleIcon = ({ name, size = 20, className = "" }) => {
            const icons = {
                wallet: <path d="M21 12V7H5a2 2 0 0 1 0-4h14v4" />,
                plus: <path d="M12 5v14M5 12h14" />,
                trash: <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />,
                check: <path d="m22 2-11 11-5-5" />,
                x: <path d="M18 6 6 18M6 6l12 12" />,
                chevronRight: <path d="m9 18 6-6-6-6" />,
                chart: <path d="M3 3v18h18M18 17V9M13 17V5M8 17v-3" />,
                checkSquare: <g><rect x="3" y="3" width="18" height="18" rx="2" ry="2" /><path d="m9 12 2 2 4-4" /></g>,
                square: <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />,
                info: <g><circle cx="12" cy="12" r="10" /><path d="M12 16v-4M12 8h.01" /></g>,
                calendar: <path d="M19 4H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2zM16 2v4M8 2v4M3 10h18" />,
                users: <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2M9 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75" />
            };

            return (
                <svg 
                    width={size} 
                    height={size} 
                    viewBox="0 0 24 24" 
                    fill="none" 
                    stroke="currentColor" 
                    strokeWidth="2" 
                    strokeLinecap="round" 
                    strokeLinejoin="round" 
                    className={className}
                >
                    {icons[name] || <circle cx="12" cy="12" r="10" />}
                </svg>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('current');
            const [members, setMembers] = useState(() => {
                const saved = localStorage.getItem('members_v2');
                return saved ? JSON.parse(saved) : ['二哥', '大哥', '三弟', '倩瑜'];
            });
            const [isMemberModalOpen, setIsMemberModalOpen] = useState(false);
            const [newMemberName, setNewMemberName] = useState('');
            
            const [expenses, setExpenses] = useState(() => {
                const saved = localStorage.getItem('expenses_v8');
                return saved ? JSON.parse(saved) : [];
            });
            
            const [history, setHistory] = useState(() => {
                // 優先從檔案讀取，若檔案不存在則從 localStorage 遷移
                const fileData = loadHistoryFromFile();
                if (fileData.length > 0) {
                    return fileData;
                }
                // 遷移舊資料
                const saved = localStorage.getItem('history_v8');
                if (saved) {
                    const oldData = JSON.parse(saved);
                    saveHistoryToFile(oldData);
                    localStorage.removeItem('history_v8');
                    return oldData;
                }
                return [];
            });

            const [viewingRecord, setViewingRecord] = useState(null);
            const [confirmStep, setConfirmStep] = useState(0);

            useEffect(() => {
                localStorage.setItem('members_v2', JSON.stringify(members));
            }, [members]);

            useEffect(() => {
                localStorage.setItem('expenses_v8', JSON.stringify(expenses));
            }, [expenses]);
            
            useEffect(() => {
                // 將歷史紀錄儲存到檔案
                saveHistoryToFile(history);
            }, [history]);

            const handleAddMember = () => {
                if (newMemberName && !members.includes(newMemberName)) {
                    setMembers([...members, newMemberName]);
                    setNewMemberName('');
                }
            };

            const handleRemoveMember = (member) => {
                if (members.length > 2) {
                    setMembers(members.filter(m => m !== member));
                } else {
                    alert("至少需要兩位成員");
                }
            };

            const calculateResults = (expenseList) => {
                const stats = {};
                members.forEach(m => stats[m] = { paid: 0, shouldPay: 0 });
                
                let totalPool = 0; // 總本期公費支出
                let publicFund = 0; // 公用基金（大家多付的部分）

                expenseList.forEach(exp => {
                    const amt = parseFloat(exp.amount) || 0;
                    const splitWith = exp.splitWith || [];
                    if (amt <= 0) return;
                    
                    // 只計算公費到總支出
                    if (exp.type === 'public') {
                        totalPool += amt;
                    }

                    const payer = exp.payer;
                    if (stats[payer]) stats[payer].paid += amt;

                    if (splitWith.length > 0) {
                        const perPerson = amt / splitWith.length;
                        splitWith.forEach(m => {
                            // Only count if member still exists
                            if (stats[m]) stats[m].shouldPay += perPerson;
                        });
                    }
                });

                // 計算公用基金（所有成員多付的總額）
                members.forEach(m => {
                    const net = stats[m].shouldPay - stats[m].paid;
                    if (net < 0) { // 如果該成員多付了
                        publicFund += Math.abs(net);
                    }
                });

                return { 
                    totalPool,
                    totalPaid: stats['二哥'] ? stats['二哥'].paid : 0,
                    ergeShouldPay: stats['二哥'] ? stats['二哥'].shouldPay : 0,
                    finalBalance: stats['二哥'] ? (stats['二哥'].paid - stats['二哥'].shouldPay) : 0, 
                    publicFund,
                    details: stats 
                };
            };

            const summary = useMemo(() => calculateResults(expenses), [expenses, members]);

            const addExpense = (type) => {
                const defaultPayer = members.includes('二哥') ? '二哥' : members[0];
                const newExp = {
                    id: Date.now(),
                    title: type === 'public' ? '水電/瓦斯費(雙月)' : '個人當月支付',
                    amount: '',
                    type: type,
                    payer: type === 'public' ? defaultPayer : (members.length > 1 ? members[1] : members[0]),
                    splitWith: type === 'public' ? [...members] : []
                };
                setExpenses([newExp, ...expenses]);
            };

            const toggleSelectAll = (id) => {
                setExpenses(expenses.map(exp => {
                    if (exp.id === id) {
                        const isAll = exp.splitWith.length === members.length;
                        return { ...exp, splitWith: isAll ? [] : [...members] };
                    }
                    return exp;
                }));
            };

            const handleFinalize = () => {
                if (expenses.length === 0) return;
                if (confirmStep === 0) {
                    setConfirmStep(1);
                    setTimeout(() => setConfirmStep(0), 3000);
                    return;
                }
                const record = {
                    id: Date.now(),
                    date: new Date().toLocaleString(),
                    month: `${new Date().getFullYear()}年${new Date().getMonth() + 1}月`,
                    summary: summary,
                    rawExpenses: [...expenses]
                };
                setHistory([record, ...history]);
                setExpenses([]);
                setConfirmStep(0);
                setActiveTab('history');
            };

            const exportToExcel = (record) => {
                try {
                if (typeof XLSX === 'undefined') {
                    alert('Excel 元件載入失敗，可能有網路問題，請檢查連線。');
                    return;
                }

                const wb = XLSX.utils.book_new();

                const summaryData = [
                    [`${record.month} 家計結算報表`],
                    [`結算日期: ${record.date}`],
                    [],
                    ['成員', '應付分擔', '已先墊付', '結算金額 (負值=二哥需退款)'],
                ];

                members.forEach(m => {
                    const s = record.summary.details[m];
                    const net = s.shouldPay - s.paid;
                    summaryData.push([
                        m, 
                        s.shouldPay, 
                        s.paid, 
                        net
                    ]);
                });

                summaryData.push([]);
                summaryData.push(['二哥最終收回總額', record.summary.finalBalance]);

                const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
                wsSummary['!cols'] = [{wch: 15}, {wch: 15}, {wch: 15}, {wch: 35}];
                XLSX.utils.book_append_sheet(wb, wsSummary, "結算總表");

                const detailsHeader = ['項目', '金額', '類型', '支付者', '分攤成員'];
                const detailsData = record.rawExpenses.map(ex => [
                    ex.title,
                    parseFloat(ex.amount),
                    ex.type === 'public' ? '公費' : '代墊',
                    ex.type === 'public' ? '二哥' : ex.payer,
                    ex.splitWith.join(', ')
                ]);

                const wsDetails = XLSX.utils.aoa_to_sheet([detailsHeader, ...detailsData]);
                wsDetails['!cols'] = [{wch: 30}, {wch: 12}, {wch: 10}, {wch: 10}, {wch: 30}];
                XLSX.utils.book_append_sheet(wb, wsDetails, "支出明細");

                XLSX.writeFile(wb, `家計結算_${record.month}.xlsx`);
                alert('匯出成功！檔案已儲存。');
                } catch (e) {
                    console.error(e);
                    alert('匯出發生錯誤: ' + e.message);
                }
            };

            return (
                <div className="min-h-screen pb-12">
                    <header className="bg-white border-b px-6 py-4 flex justify-between items-center sticky top-0 z-30 shadow-sm">
                        <div className="flex items-center gap-2 text-slate-800">
                            <div className="bg-indigo-600 p-2 rounded-lg text-white">
                                <SimpleIcon name="wallet" size={18} />
                            </div>
                            <h1 className="text-lg font-bold tracking-tight">家計分攤器 <span className="text-indigo-600 font-black"></span></h1>
                        </div>
                        <div className="flex bg-slate-100 p-1 rounded-xl items-center gap-1">
                            <button onClick={() => setActiveTab('current')} className={`px-4 py-1.5 rounded-lg text-sm font-bold transition-all ${activeTab === 'current' ? 'tab-active' : 'text-slate-500'}`}>當前帳目</button>
                            <button onClick={() => setActiveTab('history')} className={`px-4 py-1.5 rounded-lg text-sm font-bold transition-all ${activeTab === 'history' ? 'tab-active' : 'text-slate-500'}`}>歷史結算</button>
                            <div className="w-px h-6 bg-slate-200 mx-1"></div>
                            <button onClick={() => setIsMemberModalOpen(true)} className="px-3 py-1.5 rounded-lg text-slate-500 hover:bg-white hover:text-indigo-600 transition-all font-bold text-xs flex items-center gap-1">
                                <SimpleIcon name="users" size={14} /> 成員
                            </button>
                        </div>
                    </header>

                    <main className="max-w-6xl mx-auto p-6">
                        {activeTab === 'current' ? (
                            <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                                <div className="lg:col-span-7 space-y-4">
                                    <div className="flex justify-between items-center">
                                        <h2 className="text-xl font-bold text-slate-800">支出細目</h2>
                                        <div className="flex gap-2">
                                            <button onClick={() => addExpense('personal')} className="bg-white border border-slate-200 px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-1 hover:bg-slate-50 text-slate-600 shadow-sm">
                                                <SimpleIcon name="plus" size={14} /> 個人代墊
                                            </button>
                                            <button onClick={() => addExpense('public')} className="bg-indigo-600 text-white px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-1 hover:bg-indigo-700 shadow-md">
                                                <SimpleIcon name="plus" size={14} /> 公費支出
                                            </button>
                                        </div>
                                    </div>

                                    {expenses.length === 0 && (
                                        <div className="bg-white rounded-3xl p-20 text-center border-2 border-dashed border-slate-200">
                                            <div className="text-slate-300 mb-2 font-bold">目前沒有任何支出</div>
                                            <p className="text-xs text-slate-400 font-medium">點選上方按鈕開始記帳</p>
                                        </div>
                                    )}

                                    {expenses.map(exp => (
                                        <div key={exp.id} className="bg-white p-5 rounded-3xl border shadow-sm space-y-4 hover:shadow-md transition-all relative">
                                            <button onClick={() => setExpenses(expenses.filter(ex => ex.id !== exp.id))} className="absolute top-4 right-4 text-slate-400 hover:text-rose-500 transition-colors">
                                                <SimpleIcon name="trash" size={18} />
                                            </button>
                                            <div className="flex items-start gap-4 pr-8">
                                                <div className="flex-1 space-y-2">
                                                    <div className="flex items-center gap-2">
                                                        <span className={`text-xs font-black px-2 py-0.5 rounded ${exp.type === 'public' ? 'bg-indigo-100 text-indigo-700' : 'bg-amber-100 text-amber-700'}`}>
                                                            {exp.type === 'public' ? '公費' : '代墊'}
                                                        </span>
                                                        <input 
                                                            className="w-full font-bold text-slate-700 outline-none bg-transparent"
                                                            value={exp.title}
                                                            placeholder="輸入支出項目..."
                                                            onChange={e => setExpenses(expenses.map(ex => ex.id === exp.id ? {...ex, title: e.target.value} : ex))}
                                                        />
                                                    </div>
                                                </div>
                                                <div className="flex flex-col items-end gap-2">
                                                    <div className="flex items-center bg-slate-50 px-3 py-2 rounded-xl border border-slate-100 focus-within:border-indigo-300">
                                                        <span className="text-xs text-slate-400 font-bold mr-1">$</span>
                                                        <input 
                                                            type="number" className="bg-transparent font-black w-24 text-right outline-none text-slate-800 text-lg"
                                                            value={exp.amount}
                                                            placeholder="0"
                                                            onChange={e => setExpenses(expenses.map(ex => ex.id === exp.id ? {...ex, amount: e.target.value} : ex))}
                                                        />
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-slate-50">
                                                <div>
                                                    <div className="flex items-center justify-between mb-2">
                                                        <div className="flex items-center gap-2">
                                                            <span className="text-xs font-bold text-slate-400 uppercase tracking-widest">分擔成員</span>
                                                            {exp.splitWith.length === 0 && <span className="text-[10px] text-rose-500 font-bold bg-rose-50 px-1.5 rounded flex items-center gap-1"><SimpleIcon name="info" size={10} /> 未選擇</span>}
                                                        </div>
                                                        <button onClick={() => toggleSelectAll(exp.id)} className="text-xs text-indigo-500 font-bold hover:underline">
                                                            {exp.splitWith.length === members.length ? '取消全選' : '全選'}
                                                        </button>
                                                    </div>
                                                    <div className="flex flex-wrap gap-1.5">
                                                        {members.map(m => (
                                                            <button 
                                                                key={m}
                                                                onClick={() => {
                                                                    const next = exp.splitWith.includes(m) ? exp.splitWith.filter(i => i !== m) : [...exp.splitWith, m];
                                                                    setExpenses(expenses.map(ex => ex.id === exp.id ? {...ex, splitWith: next} : ex));
                                                                }}
                                                                className={`text-[11px] px-3 py-1.5 rounded-xl font-bold transition-all ${exp.splitWith.includes(m) ? 'bg-indigo-600 text-white shadow-sm' : 'bg-slate-100 text-slate-400'}`}
                                                            >{m}</button>
                                                        ))}
                                                    </div>
                                                </div>
                                                <div className="flex flex-col items-end">
                                                    <span className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">支付者</span>
                                                    <select 
                                                        className={`w-full text-center py-2 font-bold rounded-xl border text-sm outline-none cursor-pointer ${exp.type === 'public' ? 'bg-indigo-50 text-indigo-700 border-indigo-100' : 'bg-slate-50 text-slate-700 border-slate-200'}`}
                                                        value={exp.payer}
                                                        onChange={e => setExpenses(expenses.map(ex => ex.id === exp.id ? {...ex, payer: e.target.value} : ex))}
                                                    >
                                                        {members.map(m => <option key={m} value={m}>{m} {exp.type === 'public' ? '支付' : '代墊'}</option>)}
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                <div className="lg:col-span-5">
                                    <div className="bg-slate-900 text-white rounded-[2.5rem] shadow-2xl p-8 sticky top-24 border border-white/10">
                                        <div className="flex items-center gap-2 mb-8 justify-between">
                                            <div className="flex items-center gap-2">
                                                <div className="p-2 bg-indigo-500/20 rounded-lg">
                                                    <SimpleIcon name="chart" size={18} className="text-indigo-400" />
                                                </div>
                                                <h3 className="font-black text-lg">目前統計結算</h3>
                                            </div>
                                            <div className="text-right">
                                                <p className="text-[10px] text-slate-400 font-bold uppercase">本期公費總額</p>
                                                <p className="text-white font-mono font-bold">${Math.round(summary.totalPool).toLocaleString()}</p>
                                            </div>
                                        </div>

                                        <div className="space-y-6">
                                            <div className="grid grid-cols-2 gap-4">
                                                <div className="glass-card p-4 rounded-2xl">
                                                    <p className="text-[10px] font-bold text-white/40 uppercase mb-1">二哥已付</p>
                                                    <p className="text-xl font-black font-mono text-white">${Math.round(summary.totalPaid).toLocaleString()}</p>
                                                </div>
                                                <div className="glass-card p-4 rounded-2xl">
                                                    <p className="text-[10px] font-bold text-white/40 uppercase mb-1">二哥應自付</p>
                                                    <p className="text-xl font-black font-mono text-white/60">${Math.round(summary.ergeShouldPay).toLocaleString()}</p>
                                                </div>
                                            </div>

                                            <div className="bg-gradient-to-br from-indigo-600 to-violet-700 p-6 rounded-3xl shadow-lg relative overflow-hidden">
                                                <div className="relative z-10 space-y-4">
                                                    <div>
                                                        <p className="text-xs font-bold text-white/80 uppercase mb-1">二哥多付金額</p>
                                                        <p className="text-5xl font-black font-mono leading-none tracking-tight">
                                                            ${Math.round(Math.abs(summary.finalBalance)).toLocaleString()}
                                                        </p>
                                                        <p className="text-[10px] text-indigo-200 font-medium mt-1">
                                                            {
                                                                summary.finalBalance > 0 ? '其他成員應付給二哥的總額' : 
                                                                summary.finalBalance < 0 ? '二哥應拿出來分給成員的錢' : 
                                                                '目前帳務平衡'
                                                            }
                                                        </p>
                                                    </div>

                                                    {summary.publicFund > 0 && (
                                                        <div className="bg-white/10 p-3 rounded-xl border border-white/20 backdrop-blur-sm">
                                                            <div className="flex items-center gap-2 text-emerald-300 mb-1">
                                                                <SimpleIcon name="wallet" size={14} />
                                                                <p className="text-xs font-black uppercase">公用基金餘額</p>
                                                            </div>
                                                            <p className="text-2xl font-black font-mono text-white">
                                                                ${Math.round(summary.publicFund).toLocaleString()}
                                                            </p>
                                                            <p className="text-[10px] text-white/60 font-medium mt-0.5">大家多付的部分，可作為下期抵扣</p>
                                                        </div>
                                                    )}
                                                </div>
                                                <SimpleIcon name="wallet" size={80} className="absolute -bottom-4 -right-4 text-white/10 rotate-12" />
                                            </div>

                                            <div className="space-y-3 pt-6 border-t border-white/10">
                                                <div className="flex justify-between items-center px-1">
                                                    <p className="text-[10px] font-black text-white/40 uppercase tracking-[0.2em]">各成員結算明細</p>
                                                </div>
                                                {members.map(m => {
                                                    const s = summary.details[m];
                                                    const net = s.shouldPay - s.paid;
                                                    
                                                    let amountDisplay, statusText;
                                                    if (m === '二哥') {
                                                        // 二哥特殊顯示：直接顯示多付金額
                                                        if (net < 0) {
                                                            amountDisplay = <span className="text-indigo-400">${Math.round(Math.abs(net)).toLocaleString()}</span>;
                                                            statusText = <span className="text-indigo-300 text-[10px]">多付金額</span>;
                                                        } else if (net > 0) {
                                                            amountDisplay = <span className="text-rose-400">${Math.round(net).toLocaleString()}</span>;
                                                            statusText = <span className="text-rose-300 text-[10px]">需補款項</span>;
                                                        } else {
                                                            amountDisplay = <span className="text-emerald-400">已結清</span>;
                                                            statusText = <span className="text-emerald-300 text-[10px]">${Math.round(s.paid).toLocaleString()}</span>;
                                                        }
                                                    } else if (net > 0) {
                                                        // 該成員應付但還沒付夠 → 需付給二哥
                                                        amountDisplay = <span className="text-rose-400">${Math.round(net).toLocaleString()}</span>;
                                                        statusText = <span className="text-rose-300 text-[10px]">→ 應付二哥</span>;
                                                    } else if (net < 0) {
                                                        // 該成員多付了 → 二哥應退款給他
                                                        amountDisplay = <span className="text-amber-400">${Math.round(Math.abs(net)).toLocaleString()}</span>;
                                                        statusText = <span className="text-amber-300 text-[10px]">← 二哥應退</span>;
                                                    } else {
                                                        if (s.paid > 0) {
                                                            amountDisplay = <span className="text-emerald-400">已結清</span>;
                                                            statusText = <span className="text-emerald-300 text-[10px]">${Math.round(s.paid).toLocaleString()}</span>;
                                                        } else {
                                                            amountDisplay = <span className="text-white/20">無支出</span>;
                                                            statusText = <span className="text-white/20 text-[10px]">-</span>;
                                                        }
                                                    }

                                                    return (
                                                        <div key={m} className="flex justify-between items-center glass-card p-3 rounded-2xl">
                                                            <div>
                                                                <p className="text-sm font-bold text-white">{m}</p>
                                                                <p className="text-[9px] text-white/60 font-bold">應付 ${Math.round(s.shouldPay).toLocaleString()} / 已付 ${Math.round(s.paid).toLocaleString()}</p>
                                                            </div>
                                                            <div className="text-right">
                                                                <p className="text-sm font-black font-mono">
                                                                    {amountDisplay}
                                                                </p>
                                                                <p className="font-bold">
                                                                    {statusText}
                                                                </p>
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>

                                            <button 
                                                onClick={handleFinalize}
                                                disabled={expenses.length === 0}
                                                className={`w-full py-4 rounded-2xl font-black text-sm transition-all shadow-xl ${confirmStep === 1 ? 'bg-rose-500 animate-pulse' : 'bg-white text-slate-900 hover:bg-indigo-50'} disabled:opacity-20`}
                                            >
                                                {confirmStep === 1 ? '確認結算並封存？' : '立即進行本月結算'}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {history.length === 0 && (
                                    <div className="col-span-full py-20 text-center text-slate-300 font-bold">尚無歷史紀錄</div>
                                )}
                                {history.map(h => (
                                    <div key={h.id} className="bg-white p-6 rounded-[2rem] border-2 border-slate-50 shadow-sm cursor-pointer hover:border-indigo-200 transition-all group relative" onClick={() => setViewingRecord(h)}>
                                        <div className="flex justify-between items-start mb-4">
                                            <div className="p-3 bg-slate-50 rounded-2xl group-hover:bg-indigo-50 transition-colors">
                                                <SimpleIcon name="calendar" size={24} className="text-slate-400 group-hover:text-indigo-500" />
                                            </div>
                                            <button onClick={e => { e.stopPropagation(); setHistory(history.filter(i => i.id !== h.id)); }} className="text-slate-100 group-hover:text-rose-300 p-1">
                                                <SimpleIcon name="trash" size={16} />
                                            </button>
                                        </div>
                                        <h3 className="font-black text-slate-800 text-lg">{h.month} 結算單</h3>
                                        <p className="text-xs text-slate-400 font-bold mb-6">{h.date}</p>
                                        <div className="flex justify-between items-end bg-indigo-50/50 p-4 rounded-2xl border border-indigo-50">
                                            <div className="text-[10px] font-black text-indigo-400 uppercase">二哥收回</div>
                                            <div className="text-2xl font-black text-indigo-600 font-mono">${Math.round(h.summary.finalBalance).toLocaleString()}</div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>

                    {/* 強化後的歷史紀錄詳細資訊 Modal */}
                    {viewingRecord && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay" onClick={() => setViewingRecord(null)}>
                            <div className="bg-white w-full max-w-4xl rounded-[2.5rem] shadow-2xl flex flex-col max-h-[90vh] overflow-hidden" onClick={e => e.stopPropagation()}>
                                {/* Header */}
                                <div className="p-8 border-b bg-slate-50 flex justify-between items-start">
                                    <div className="flex gap-4">
                                        <div className="bg-indigo-600 p-4 rounded-[1.5rem] text-white shadow-lg shadow-indigo-100">
                                            <SimpleIcon name="calendar" size={28} />
                                        </div>
                                        <div>
                                            <h2 className="font-black text-slate-800 text-2xl tracking-tight">{viewingRecord.month} 結算報表</h2>
                                            <p className="text-sm text-slate-400 font-bold">結算完成於 {viewingRecord.date}</p>
                                        </div>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => exportToExcel(viewingRecord)} className="bg-emerald-500 text-white px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 hover:bg-emerald-600 shadow-sm transition-all">
                                            <SimpleIcon name="chart" size={16} /> 匯出 Excel
                                        </button>
                                        <button onClick={() => setViewingRecord(null)} className="bg-white p-2 rounded-xl text-slate-300 hover:text-slate-600 border border-slate-100 shadow-sm"><SimpleIcon name="x" size={20} /></button>
                                    </div>
                                </div>

                                <div className="flex-1 overflow-y-auto custom-scrollbar p-8">
                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                        {/* 支出細項表格 */}
                                        <div className="space-y-6">
                                            <div className="flex items-center gap-2">
                                                <SimpleIcon name="wallet" size={18} className="text-indigo-500" />
                                                <h4 className="font-black text-slate-800 text-sm uppercase tracking-widest">支出清單 ({viewingRecord.rawExpenses.length} 筆)</h4>
                                            </div>
                                            <div className="space-y-3">
                                                {viewingRecord.rawExpenses.map(ex => (
                                                    <div key={ex.id} className="bg-slate-50/50 p-4 rounded-2xl border border-slate-100 flex justify-between items-center">
                                                        <div className="space-y-1">
                                                            <div className="flex items-center gap-2">
                                                                <span className={`text-[9px] font-black px-1.5 py-0.5 rounded ${ex.type === 'public' ? 'bg-indigo-100 text-indigo-600' : 'bg-amber-100 text-amber-600'}`}>
                                                                    {ex.type === 'public' ? '公費' : '代墊'}
                                                                </span>
                                                                <p className="font-bold text-slate-800 text-sm">{ex.title || '無名稱項目'}</p>
                                                            </div>
                                                            <p className="text-[10px] text-slate-400 font-medium">支付者：{ex.type === 'public' ? '二哥' : ex.payer} | 分攤：{ex.splitWith.join(', ')}</p>
                                                        </div>
                                                        <p className="font-black font-mono text-slate-700">${Math.round(ex.amount).toLocaleString()}</p>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>

                                        {/* 成員分攤分析 */}
                                        <div className="space-y-6">
                                            <div className="flex items-center gap-2">
                                                <SimpleIcon name="users" size={18} className="text-indigo-500" />
                                                <h4 className="font-black text-slate-800 text-sm uppercase tracking-widest">成員分攤分析</h4>
                                            </div>
                                            <div className="bg-slate-900 rounded-[2rem] p-6 space-y-4">
                                                {members.map(m => {
                                                    const s = viewingRecord.summary.details[m];
                                                    const net = s.shouldPay - s.paid;
                                                    return (
                                                        <div key={m} className="flex justify-between items-center border-b border-white/5 pb-4 last:border-0 last:pb-0">
                                                            <div>
                                                                <p className="text-white font-bold text-sm">{m}</p>
                                                                <p className="text-[10px] text-white/30 font-bold uppercase">應付 ${Math.round(s.shouldPay).toLocaleString()} | 已付 ${Math.round(s.paid).toLocaleString()}</p>
                                                            </div>
                                                            <div className="text-right">
                                                                <p className={`text-sm font-black font-mono ${
                                                                    m === '二哥' 
                                                                        ? (net < 0 ? 'text-indigo-400' : net > 0 ? 'text-rose-400' : 'text-emerald-400')
                                                                        : (net > 0 ? 'text-rose-400' : (net < 0 ? 'text-amber-400' : 'text-emerald-400'))
                                                                }`}>
                                                                    {net !== 0 ? `$${Math.round(Math.abs(net)).toLocaleString()}` : '已結清'}
                                                                </p>
                                                                <p className={`text-[10px] font-bold ${
                                                                    m === '二哥' 
                                                                        ? (net < 0 ? 'text-indigo-300' : net > 0 ? 'text-rose-300' : 'text-emerald-300')
                                                                        : (net > 0 ? 'text-rose-300' : (net < 0 ? 'text-amber-300' : 'text-emerald-300'))
                                                                }`}>
                                                                    {m === '二哥' 
                                                                        ? (net < 0 ? '多付金額' : (net > 0 ? '需補款項' : '無欠款'))
                                                                        : (net > 0 ? '→ 應付二哥' : (net < 0 ? '← 二哥應退' : '無欠款'))
                                                                    }
                                                                </p>
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                            
                                            {/* 二哥最終統計卡片 */}
                                            <div className="bg-indigo-600 rounded-[2rem] p-6 text-white shadow-xl shadow-indigo-100 relative overflow-hidden">
                                                <div className="relative z-10 space-y-4">
                                                    <div>
                                                        <p className="text-[10px] font-black text-white/60 uppercase tracking-widest mb-1">二哥多付金額</p>
                                                        <div className="flex justify-between items-end">
                                                            <p className="text-3xl font-black font-mono">
                                                                ${Math.round(Math.abs(viewingRecord.summary.finalBalance)).toLocaleString()}
                                                            </p>
                                                            <SimpleIcon name="check" size={30} className="text-white/20 mb-1" />
                                                        </div>
                                                        <p className="text-[10px] text-indigo-200 font-medium mt-1">
                                                            {viewingRecord.summary.finalBalance > 0 ? '其他成員應付給二哥的總額' : (viewingRecord.summary.finalBalance < 0 ? '二哥應拿出來分給成員的錢' : '目前帳務平衡')}
                                                        </p>
                                                    </div>

                                                    {(viewingRecord.summary.publicFund || viewingRecord.summary.refundNeeded || (() => {
                                                        // Fallback for old records: calculate publicFund on the fly
                                                        let fund = 0;
                                                        Object.keys(viewingRecord.summary.details).forEach(m => {
                                                            const s = viewingRecord.summary.details[m];
                                                            const net = s.shouldPay - s.paid;
                                                            if (net < 0) fund += Math.abs(net);
                                                        });
                                                        return fund;
                                                    })()) > 0 && (
                                                        <div className="bg-white/10 p-3 rounded-xl border border-white/20 backdrop-blur-sm">
                                                            <div className="flex items-center gap-2 text-emerald-300 mb-1">
                                                                <SimpleIcon name="wallet" size={14} />
                                                                <p className="text-xs font-black uppercase">公用基金餘額</p>
                                                            </div>
                                                            <p className="text-2xl font-black font-mono text-white">
                                                                ${Math.round(viewingRecord.summary.publicFund || viewingRecord.summary.refundNeeded || (() => {
                                                                    let fund = 0;
                                                                    Object.keys(viewingRecord.summary.details).forEach(m => {
                                                                        const s = viewingRecord.summary.details[m];
                                                                        const net = s.shouldPay - s.paid;
                                                                        if (net < 0) fund += Math.abs(net);
                                                                    });
                                                                    return fund;
                                                                })()).toLocaleString()}
                                                            </p>
                                                            <p className="text-[10px] text-white/60 font-medium mt-0.5">大家多付的部分，可作為下期抵扣</p>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="p-6 bg-slate-50 border-t flex justify-center">
                                    <button onClick={() => setViewingRecord(null)} className="px-8 py-3 bg-white border border-slate-200 rounded-2xl text-slate-600 font-bold text-sm hover:bg-slate-100 transition-colors shadow-sm">
                                        關閉報表
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 成員管理 Modal */}
                    {isMemberModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay" onClick={() => setIsMemberModalOpen(false)}>
                            <div className="bg-white w-full max-w-md rounded-[2.5rem] shadow-2xl overflow-hidden" onClick={e => e.stopPropagation()}>
                                <div className="p-6 border-b bg-slate-50 flex justify-between items-center">
                                    <h3 className="font-black text-slate-800 text-lg">成員管理</h3>
                                    <button onClick={() => setIsMemberModalOpen(false)} className="text-slate-400 hover:text-slate-600"><SimpleIcon name="x" size={20} /></button>
                                </div>
                                <div className="p-6 space-y-6">
                                    <div className="space-y-3">
                                        <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">現有成員 ({members.length})</p>
                                        <div className="space-y-2 max-h-60 overflow-y-auto pr-2 custom-scrollbar">
                                            {members.map(m => (
                                                <div key={m} className="flex justify-between items-center bg-slate-50 p-3 rounded-xl border border-slate-100">
                                                    <span className="font-bold text-slate-700">{m}</span>
                                                    <button 
                                                        onClick={() => handleRemoveMember(m)}
                                                        className="text-slate-300 hover:text-rose-500 transition-colors p-1"
                                                        title="移除成員"
                                                    >
                                                        <SimpleIcon name="trash" size={16} />
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="pt-6 border-t border-slate-100">
                                        <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">新增成員</p>
                                        <div className="flex gap-2">
                                            <input 
                                                className="flex-1 bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 font-bold text-slate-700 outline-none focus:border-indigo-300 transition-colors"
                                                placeholder="輸入成員名稱..."
                                                value={newMemberName}
                                                onChange={e => setNewMemberName(e.target.value)}
                                                onKeyDown={e => e.key === 'Enter' && handleAddMember()}
                                            />
                                            <button 
                                                onClick={handleAddMember}
                                                disabled={!newMemberName}
                                                className="bg-indigo-600 text-white px-4 py-2 rounded-xl font-bold hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-md"
                                            >
                                                新增
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>